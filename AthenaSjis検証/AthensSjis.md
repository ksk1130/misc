# AthenaでSJISのファイルを扱う

[TOC]

## 目的

AthenaでSJISのファイルが文字化けする。型定義(varchar)を疑ったので、以下のバリエーションで検証する

| #    | 文字コード | ダブルクオート | 列定義  |
| ---- | ---------- | -------------- | ------- |
| 1    | SJIS       | なし           | varchar |
| 2    | SJIS       | なし           | string  |
| 3    | SJIS       | あり           | varchar |
| 4    | SJIS       | あり           | string  |

## まとめ

1. 末尾列の日本語項目の文字化けは末尾に,","を入れればよさそう
2. クオート付きSJISなら、varcharにはクオート分(⁺2)する必要あり
3. クオート付きSJISの場合、int(数値)の項目はくくらない(くくると値が出てこない)
4. クオート付きSJISで、数値(intなどで扱いたい値)をクオートで囲う場合は、当該列はvarcharやstringで扱う

## 操作

### 元データの作成

数値と文字列が混在したデータを用意する(ヘッダはなし)

下記のデータについて

・クオート有り無しそれぞれのファイルを作成する

| #|都道府県|県庁所在地|
|--|--------|----------|
| 1|北海道  |札幌市    |
| 2|青森県  |青森市    |
| 3|岩手県  |盛岡市    |
| 4|宮城県  |仙台市    |
| 5|秋田県  |秋田市    |
| 6|山形県  |山形市    |
| 7|福島県  |福島市    |
| 8|茨城県  |水戸市    |
| 9|栃木県  |宇都宮市  |
|10|群馬県  |前橋市    |
|11|埼玉県  |さいたま市|
|12|千葉県  |千葉市    |
|13|東京都  |新宿区    |
|14|神奈川県|横浜市    |
|15|新潟県  |新潟市    |
...

### ターゲットのGDCのDB作成

```
test0420
```

 ### ファイル配置用のS3フォルダ作成&ファイル配置

```bash
s3://target_bucket/test0420/noquot
s3://target_bucket/test0420/quot
```
### テーブル作成
#### テーブル作成(クオートなし,varchar)

```sql
create external table test0420.kencho_noquot_varchar(
    tdkf_no int,
    tdfk_name varchar(4),
    kencho_shozaichi varchar(5)
)
ROW FORMAT SerDe 'org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe'
WITH SERDEPROPERTIES (
'field.delim' = ','
)
LOCATION 's3://target_bucket/test0420/noquot'
TBLPROPERTIES (
'serialization.encoding'='SJIS'
);
```

#### テーブル作成(クオートなし,string)

```sql
create external table test0420.kencho_noquot_string(
    tdkf_no int,
    tdfk_name string,
    kencho_shozaichi string
)
ROW FORMAT SerDe 'org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe'
WITH SERDEPROPERTIES (
'field.delim' = ','
)
LOCATION 's3://target_bucket/test0420/noquot'
TBLPROPERTIES (
'serialization.encoding'='SJIS'
);
```

#### テーブル作成(クオートあり,varchar)

```sql
create external table test0420.kencho_quot_varchar(
    tdkf_no int,
    tdfk_name varchar(4),
    kencho_shozaichi varchar(5)
)
ROW FORMAT SerDe 'org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe'
WITH SERDEPROPERTIES (
'field.delim' = ','
)
LOCATION 's3://target_bucket/test0420/quot'
TBLPROPERTIES (
'serialization.encoding'='SJIS'
);
```

#### テーブル作成(クオートあり,string)

```sql
create external table test0420.kencho_quot_string(
    tdkf_no int,
    tdfk_name string,
    kencho_shozaichi string
)
ROW FORMAT SerDe 'org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe'
WITH SERDEPROPERTIES (
'field.delim' = ','
)
LOCATION 's3://target_bucket/test0420/quot'
TBLPROPERTIES (
'serialization.encoding'='SJIS'
);
```

### 結果

#### クオートなし、string(NG)

```
1	1	北海道	札幌市
2	2	青森県	青森市
3	3	岩手県	盛岡市
4	4	宮城県	仙台市
5	5	秋田県	秋田市
6	6	山形県	山形市
7	7	福島県	福島市
8	8	茨城県	水戸市
9	9	栃木県	宇都宮市
10	10	群馬県	前橋市s
11	11	埼玉県	さいたま市
12	12	千葉県	千葉市ま市
13	13	東京都	新宿区ま市
14	14	神奈川県	横浜市市
...
```

#### クオートなし、varchar(NG)

```
1	1	北海道	札幌市
2	2	青森県	青森市
3	3	岩手県	盛岡市
4	4	宮城県	仙台市
5	5	秋田県	秋田市
6	6	山形県	山形市
7	7	福島県	福島市
8	8	茨城県	水戸市
9	9	栃木県	宇都宮市
10	10	群馬県	前橋市s
11	11	埼玉県	さいたま市
12	12	千葉県	千葉市ま市
13	13	東京都	新宿区ま市
14	14	神奈川県	横浜市市
...
```

#### クオートあり、string(NG)

```
1		"北海道"	"札幌市"
2		"青森県"	"青森市"
3		"岩手県"	"盛岡市"
4		"宮城県"	"仙台市"
5		"秋田県"	"秋田市"
6		"山形県"	"山形市"
7		"福島県"	"福島市"
8		"茨城県"	"水戸市"
9		"栃木県"	"宇都宮市"
10		"群馬県"	"前橋市""
11		"埼玉県"	"さいたま市"
12		"千葉県"	"千葉市"ﾜ市"
13		"東京都"	"新宿区"ﾜ市"
14		"神奈川県"	"横浜市"s"
...
```

#### クオートあり、varchar(NG)

```
1		"北海道	"札幌市"
2		"青森県	"青森市"
3		"岩手県	"盛岡市"
4		"宮城県	"仙台市"
5		"秋田県	"秋田市"
6		"山形県	"山形市"
7		"福島県	"福島市"
...(崩れた、tdfk_noがでない、tdfk_nameの末尾が切れてる)
```

### 対応策

#### 対策1.varcharでカラム長をバイト数(1文字2バイト)で

```sql
create external table test0420.kencho_noquot_varchar2(
    tdkf_no int,
    tdfk_name varchar(8),
    kencho_shozaichi varchar(10)
)
ROW FORMAT SerDe 'org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe'
WITH SERDEPROPERTIES (
'field.delim' = ','
)
LOCATION 's3://target_bucket/test0420/noquot'
TBLPROPERTIES (
'serialization.encoding'='SJIS'
);
```

#### 対策1の結果 →NG...(変わらず)

```
1	1	北海道	札幌市
2	2	青森県	青森市
3	3	岩手県	盛岡市
4	4	宮城県	仙台市
5	5	秋田県	秋田市
6	6	山形県	山形市
7	7	福島県	福島市
8	8	茨城県	水戸市
9	9	栃木県	宇都宮市
10	10	群馬県	前橋市s
11	11	埼玉県	さいたま市
12	12	千葉県	千葉市ま市
13	13	東京都	新宿区ま市
14	14	神奈川県	横浜市市
...
```

#### 対策2. データファイルの変更(末尾に","を追加)

```
# クオートなし
1,北海道,札幌市,
2,青森県,青森市,
3,岩手県,盛岡市,
4,宮城県,仙台市,
5,秋田県,秋田市,
6,山形県,山形市,
7,福島県,福島市,
...

# クオートあり
"1","北海道","札幌市",
"2","青森県","青森市",
"3","岩手県","盛岡市",
"4","宮城県","仙台市",
"5","秋田県","秋田市",
"6","山形県","山形市",
"7","福島県","福島市",
"8","茨城県","水戸市",
"9","栃木県","宇都宮市",
"10","群馬県","前橋市",
...
```

#### 対策2(データファイル変更)での実行結果

```
# クオートなし、varchar(OK)
1	1	北海道	札幌市
2	2	青森県	青森市
3	3	岩手県	盛岡市
4	4	宮城県	仙台市
5	5	秋田県	秋田市
6	6	山形県	山形市
7	7	福島県	福島市
8	8	茨城県	水戸市
9	9	栃木県	宇都宮市
10	10	群馬県	前橋市
11	11	埼玉県	さいたま市
12	12	千葉県	千葉市
13	13	東京都	新宿区
14	14	神奈川県	横浜市
...

# クオートなし、string(OK)
1	1	北海道	札幌市
2	2	青森県	青森市
3	3	岩手県	盛岡市
4	4	宮城県	仙台市
5	5	秋田県	秋田市
6	6	山形県	山形市
7	7	福島県	福島市
8	8	茨城県	水戸市
9	9	栃木県	宇都宮市
10	10	群馬県	前橋市
11	11	埼玉県	さいたま市
12	12	千葉県	千葉市
13	13	東京都	新宿区
14	14	神奈川県	横浜市
...

# クオートあり varchar(NG) → 対策3
1		"北海道	"札幌市"
2		"青森県	"青森市"
3		"岩手県	"盛岡市"
4		"宮城県	"仙台市"
5		"秋田県	"秋田市"
6		"山形県	"山形市"
7		"福島県	"福島市"
8		"茨城県	"水戸市"
9		"栃木県	"宇都宮市
10		"群馬県	"前橋市"
11		"埼玉県	"さいたま
12		"千葉県	"千葉市"
13		"東京都	"新宿区"
...(多分クオートの分も文字列長への考慮が必要、tdfk_noがない)

 # クオートあり string(NG) 対策4
1		"北海道"	"札幌市"
2		"青森県"	"青森市"
3		"岩手県"	"盛岡市"
4		"宮城県"	"仙台市"
5		"秋田県"	"秋田市"
6		"山形県"	"山形市"
7		"福島県"	"福島市"
8		"茨城県"	"水戸市"
...(tdfk_noがない)
```

#### 対策3. varcharにクオートの分の長さを追加(+2/カラム)

```sql
create external table test0420.kencho_quot_varchar2(
    tdkf_no int,
    tdfk_name varchar(6),
    kencho_shozaichi varchar(7)
)
ROW FORMAT SerDe 'org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe'
WITH SERDEPROPERTIES (
'field.delim' = ','
)
LOCATION 's3://target_bucket/test0420/quot'
TBLPROPERTIES (
'serialization.encoding'='SJIS'
);
```

#### 対策3の結果

```
# クオートあり、varchar(クオート分を文字列長に追加)
1		"北海道"	"札幌市"
2		"青森県"	"青森市"
3		"岩手県"	"盛岡市"
4		"宮城県"	"仙台市"
5		"秋田県"	"秋田市"
6		"山形県"	"山形市"
7		"福島県"	"福島市"
8		"茨城県"	"水戸市"
9		"栃木県"	"宇都宮市"
10		"群馬県"	"前橋市"
11		"埼玉県"	"さいたま市"
12		"千葉県"	"千葉市"
13		"東京都"	"新宿区"
...(tdfk_noは出なかったが、期待する結果となった)
```

#### 対策4. intの列はクオートで囲わない

```
1,"北海道","札幌市",
2,"青森県","青森市",
3,"岩手県","盛岡市",
4,"宮城県","仙台市",
5,"秋田県","秋田市",
6,"山形県","山形市",
7,"福島県","福島市",
8,"茨城県","水戸市",
9,"栃木県","宇都宮市",
10,"群馬県","前橋市",
11,"埼玉県","さいたま市",
...
```

#### 対策4の結果

```
# クオートあり、varchar(クオート分を文字列長に追加)
1	1	"北海道"	"札幌市"
2	2	"青森県"	"青森市"
3	3	"岩手県"	"盛岡市"
4	4	"宮城県"	"仙台市"
5	5	"秋田県"	"秋田市"
6	6	"山形県"	"山形市"
7	7	"福島県"	"福島市"
8	8	"茨城県"	"水戸市"
9	9	"栃木県"	"宇都宮市"
10	10	"群馬県"	"前橋市"
11	11	"埼玉県"	"さいたま市"
...期待する結果

# クオートあり、string
1	1	"北海道"	"札幌市"
2	2	"青森県"	"青森市"
3	3	"岩手県"	"盛岡市"
4	4	"宮城県"	"仙台市"
5	5	"秋田県"	"秋田市"
6	6	"山形県"	"山形市"
7	7	"福島県"	"福島市"
8	8	"茨城県"	"水戸市"
9	9	"栃木県"	"宇都宮市"
10	10	"群馬県"	"前橋市"
11	11	"埼玉県"	"さいたま市"
...期待する結果
```

### Spark-sqlでの見え方

#### クオートなし、varchar

```
1       北海道  札幌市
2       青森県  青森市
3       岩手県  盛岡市
4       宮城県  仙台市
5       秋田県  秋田市
6       山形県  山形市
7       福島県  福島市
8       茨城県  水戸市
9       栃木県  宇都宮市
10      群馬県  前橋市
11      埼玉県  さいたま市
12      千葉県  千葉市
13      東京都  新宿区
14      神奈川県        横浜市
15      新潟県  新潟市
16      富山県  富山市
17      石川県  金沢市
18      福井県  福井市
19      山梨県  甲府市
20      長野県  長野市
```

#### クオートなし、string

```
1       北海道  札幌市
2       青森県  青森市
3       岩手県  盛岡市
4       宮城県  仙台市
5       秋田県  秋田市
6       山形県  山形市
7       福島県  福島市
8       茨城県  水戸市
9       栃木県  宇都宮市
10      群馬県  前橋市
11      埼玉県  さいたま市
12      千葉県  千葉市
13      東京都  新宿区
14      神奈川県        横浜市
15      新潟県  新潟市
16      富山県  富山市
17      石川県  金沢市
18      福井県  福井市
19      山梨県  甲府市
20      長野県  長野市
```

#### クオートあり、varchar(tdfk_noはクオートなし)

```
1       "北海道 "札幌市"
2       "青森県 "青森市"
3       "岩手県 "盛岡市"
4       "宮城県 "仙台市"
5       "秋田県 "秋田市"
6       "山形県 "山形市"
7       "福島県 "福島市"
8       "茨城県 "水戸市"
9       "栃木県 "宇都宮市
10      "群馬県 "前橋市"
11      "埼玉県 "さいたま
12      "千葉県 "千葉市"
13      "東京都 "新宿区"
14      "神奈川 "横浜市"
15      "新潟県 "新潟市"
16      "富山県 "富山市"
17      "石川県 "金沢市"
18      "福井県 "福井市"
19      "山梨県 "甲府市"
20      "長野県 "長野市"
```

#### クオートあり、string(tdfk_noはクオートなし)

```
1       "北海道"        "札幌市"
2       "青森県"        "青森市"
3       "岩手県"        "盛岡市"
4       "宮城県"        "仙台市"
5       "秋田県"        "秋田市"
6       "山形県"        "山形市"
7       "福島県"        "福島市"
8       "茨城県"        "水戸市"
9       "栃木県"        "宇都宮市"
10      "群馬県"        "前橋市"
11      "埼玉県"        "さいたま市"
12      "千葉県"        "千葉市"
13      "東京都"        "新宿区"
14      "神奈川県"      "横浜市"
15      "新潟県"        "新潟市"
16      "富山県"        "富山市"
17      "石川県"        "金沢市"
18      "福井県"        "福井市"
19      "山梨県"        "甲府市"
20      "長野県"        "長野市"
```

